<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xushu.bookmanage.mapper.BorrowMapper">

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        insert into borrow (user_id, book_id, borrow_date, status, create_time, update_time)
        values (#{userId}, #{bookId}, #{borrowDate}, #{status}, now(), now())
    </insert>

    <select id="selectById" resultType="com.xushu.bookmanage.entity.Borrow">
        select * from borrow where id = #{id}
    </select>

    <delete id="deleteById">
        delete from borrow where id = #{id}
    </delete>

    <update id="updateById">
        update borrow
        <set>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="bookId != null">book_id = #{bookId},</if>
            <if test="borrowDate != null">borrow_date = #{borrowDate},</if>
            <if test="returnDate != null">return_date = #{returnDate},</if>
            <if test="status != null">status = #{status},</if>
            update_time = now()
        </set>
        where id = #{id}
    </update>

    <resultMap id="BorrowRecordDtoMap" type="com.xushu.bookmanage.dto.BorrowRecordDto">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="bookId" column="book_id"/>
        <result property="bookTitle" column="book_title"/>
        <result property="borrowDate" column="borrow_date"/>
        <result property="returnDate" column="return_date"/>
        <result property="status" column="status"/>
    </resultMap>

    <select id="selectBorrowList" resultMap="BorrowRecordDtoMap">
        SELECT
            b.id,
            b.user_id,
            u.username,
            b.book_id,
            bk.title AS book_title,
            b.borrow_date,
            b.return_date,
            b.status
        FROM
            borrow b
        LEFT JOIN
            user u ON b.user_id = u.id
        LEFT JOIN
            book bk ON b.book_id = bk.id
        <where>
            <if test="username != null and username != ''">
                AND u.username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="bookTitle != null and bookTitle != ''">
                AND bk.title LIKE CONCAT('%', #{bookTitle}, '%')
            </if>
            <if test="status != null">
                AND b.status = #{status}
            </if>
        </where>
        ORDER BY b.borrow_date DESC
    </select>

    <select id="findUnreturnedBorrowByUserAndBook" resultType="com.xushu.bookmanage.entity.Borrow">
        SELECT * FROM borrow
        WHERE user_id = #{userId}
          AND book_id = #{bookId}
          AND status = 0
    </select>

    <select id="countUnreturnedBorrowsByBookId" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM borrow
        WHERE book_id = #{bookId}
          AND status = 0
    </select>

</mapper>
